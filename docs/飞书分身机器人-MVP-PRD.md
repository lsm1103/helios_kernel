# 飞书分身机器人 MVP 产品需求文档（PRD）

## 1. 文档信息
- 文档版本：`v1.0`
- 文档日期：`2026-02-14`
- 适用阶段：`MVP`
- 关联文档：
  - `docs/Core Domain.md`
  - `docs/Task & Session 不可变规格.md`
  - `docs/开发架构与技术栈方案.md`
  - `docs/飞书-HITL-桥接最小API草案.md`
  - `docs/协作会话与工具会话集成-需求与功能设计汇总.md`

## 2. 背景与问题
- 团队需要将系统接入飞书，以“分身机器人”形式服务客户与内部技术团队。
- 当前协作入口在飞书，但开发执行能力在 Codex/Claude Code 等工具侧。
- 需要同时满足：
  - 飞书内连续协作与可追踪；
  - 工具侧完整执行上下文；
  - 关键决策可由人类在飞书确认并继续执行。

## 3. 产品目标
- 在飞书内提供可用的分身机器人，支持需求对话、任务派发、进度回传。
- 打通“飞书协作会话 + 工具执行会话”的最小闭环。
- 支持技术支持场景：查询 API/规则、生成技术方案、受控触发执行任务。
- 保证高风险动作必须有人类确认，所有关键行为可审计。

## 4. MVP 范围

### 4.1 In Scope（MVP 必须）
- 飞书机器人消息收发（私聊/群聊）。
- 协作会话管理（飞书线程映射到系统 Session）。
- 工具会话绑定（单协作会话下可关联多个工具 session）。
- 工具任务执行编排（Codex / Claude Code）。
- HITL 闭环（飞书交互卡片 -> webhook -> stdin 回灌）。
- 协作会话内的工具摘要卡片（约 150 字）与状态更新。
- 基础技术问答（基于规则区与接口文档）。
- 命令白名单、权限控制、审计记录。

### 4.2 Out of Scope（MVP 不做）
- 自动部署到全部外部电脑/全部内部服务器的全自动运维。
- 复杂多级审批流与组织级流程引擎。
- 工具 transcript 的长期归档与跨版本迁移。
- 多社交平台统一前端（MVP 仅飞书）。

## 5. 用户与角色
- `客户/业务用户`：在飞书中提需求、看进展、给反馈。
- `技术同学`：在飞书下发开发任务、查看工具执行结果。
- `审批人/负责人`：处理高风险确认卡片并决策继续/暂停。
- `管理员`：维护规则区、API 白名单、权限与审计策略。

## 6. 关键使用场景
- 场景 A：客户在飞书提出需求，机器人识别为开发任务并触发工具执行。
- 场景 B：工具执行中需要人工选择，机器人下发飞书卡片，用户确认后继续执行。
- 场景 C：同一协作会话绑定多个工具 session，用户可切换查看不同执行上下文。
- 场景 D：用户询问“某 API 怎么用”，机器人基于规则区与接口文档回复。

## 7. 产品原则
- 飞书会话 must 作为协作主线。
- 工具会话 must 作为执行主线。
- 协作记录与工具记录 must 逻辑隔离，避免互相污染。
- 高风险操作 must 先人类确认再执行。
- 关键动作 must 可审计、可回溯。

## 8. 功能需求（MVP）

### 8.1 FR-001 飞书接入与协作会话映射
- 系统 must 接收飞书私聊/群聊消息并识别 `chat_thread_id`、`sender_id`。
- 系统 must 按 `(project_id, chat_thread_id, contact_id)` 规则定位或创建协作会话。
- 系统 must 将机器人响应回发到原飞书线程。

### 8.2 FR-002 工具会话绑定与切换
- 单个协作会话 must 支持绑定多个工具会话。
- 系统 must 提供 `list/use/peek` 级别的会话操作能力（命令或接口）。
- 协作会话中 must 仅展示工具摘要卡片与引用链接，不写入完整 transcript。

### 8.3 FR-003 工具执行编排
- 系统 must 支持通过适配器触发 `codex` 与 `claude code` 执行任务。
- 系统 must 记录 `task_id <-> tool_session_id <-> run_id` 关联。
- 工具执行进展 must 以摘要形式持续回传协作会话。

### 8.4 FR-004 HITL（人工介入）闭环
- 工具需要人工输入时，系统 must 创建 `interaction_request`（状态 `PENDING`）。
- 系统 must 下发飞书交互卡片（选择/文本输入）。
- 用户提交后，系统 must 校验幂等并写入目标运行进程 stdin。
- 成功回灌后，系统 must 将请求状态更新为 `RESOLVED` 并记审计日志。

### 8.5 FR-005 技术支持问答
- 系统 must 支持对规则区、API 文档的检索问答。
- 回答中 should 附来源标识（文档名、章节或接口名）。
- 无法确认答案时 must 明确告知不确定并引导人工介入。

### 8.6 FR-006 安全与权限控制
- 命令执行 must 走白名单策略，未授权命令 must 拒绝。
- 高风险操作 must 需要人类确认。
- 系统 must 记录关键审计字段：操作者、时间、命令、结果、关联会话。

## 9. 非功能需求
- 可用性：MVP 运行时间 should 满足工作时段稳定可用。
- 时效性：普通消息响应 should 在可接受延迟内返回（目标秒级）。
- 一致性：命令处理 must 满足“校验 -> 状态变更 -> 事件追加”原子流程。
- 幂等性：webhook 与 HITL 回灌 must 基于 `idempotency_key` 防重放。
- 可观测性：must 提供结构化日志与基础错误指标。

## 10. 数据与状态模型（MVP 最小）
- `collab_sessions`：协作会话主记录。
- `tool_session_links`：协作会话与工具会话绑定。
- `interaction_requests`：人工介入请求与状态。
- `task_runs`：工具执行实例（含 `run_id`、状态、起止时间）。
- `rejection_audit_logs`：拒绝与失败审计。

`interaction_requests` 状态机：
- `PENDING -> RESOLVED`
- `PENDING -> EXPIRED`
- `PENDING -> CANCELLED`

## 11. 接口需求（MVP 最小）
- 飞书入站 webhook：接收消息与交互卡片回调。
- 飞书出站消息：文本、摘要卡片、交互卡片。
- 内部回灌接口：`POST /internal/tool-runs/{run_id}/stdin`。
- 工具会话查询接口：会话列表、会话切换、最近摘要查询。

详细字段以 `docs/飞书-HITL-桥接最小API草案.md` 为准。

## 12. 验收标准（Definition of Done）
- 可在飞书完成“提需求 -> 触发工具 -> 返回摘要”的完整闭环。
- 可在同一协作会话中绑定并切换至少 2 个工具会话。
- 工具触发人工确认时，飞书卡片可成功回灌并恢复执行。
- 技术问答可回答已纳入规则区的 API/规范问题。
- 高风险命令均有审批与审计记录。

## 13. 里程碑
- `M1`：飞书接入 + 协作会话映射 + 基础回复。
- `M2`：工具会话绑定 + 任务执行编排 + 摘要回传。
- `M3`：HITL 卡片闭环 + stdin 回灌 + 幂等审计。
- `M4`：规则区问答 + 权限白名单 + 稳定性加固。

## 14. 风险与缓解
- 风险：依赖工具本地私有会话格式可能随版本变化。
  - 缓解：运行时优先采集 stdout/stderr 结构化信号，私有文件仅用于补充读取。
- 风险：飞书交互卡片回调重放导致重复执行。
  - 缓解：事件幂等键 + 请求状态机双重防护。
- 风险：高风险命令误触发。
  - 缓解：默认拒绝策略 + 人工确认 + 可回滚操作手册。

## 15. 待确认项（进入下一版前锁定）
- 规则区的数据来源与更新机制（人工维护/自动同步）。
- 高风险命令分级标准（L1/L2/L3）与审批人映射。
- Web 工作台首版范围（只读查看 vs 可交互控制）。
