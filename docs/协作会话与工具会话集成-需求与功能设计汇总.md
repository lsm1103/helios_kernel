# 协作会话与工具会话集成：需求与功能设计汇总（v0.1）

## 1. 文档定位
- 本文是“需求文档 + 功能设计文档”的合并稿。
- 若必须二选一，本文更接近“功能设计文档”，因为已包含交互流程、接口草案、状态约束与落地策略。

## 2. 背景
- 系统已有协作会话概念，主要映射社交 App 会话（如飞书私聊/群聊）。
- 接入 Codex、Claude Code 等编码工具后，会引入工具侧 session 概念。
- 目标是在不破坏协作会话记录的前提下，使用并切换多个工具 session。

## 3. 核心需求（对话结论）
- 协作会话与工具会话必须分层，不混用同一历史流。
- 协作会话内可关联多个工具 session。
- 在协作会话中需要查看工具 session 聊天记录。
- 查看工具 session 记录时不得污染协作会话时间线。
- 允许在多个工具 session 之间切换查看。
- 协作会话仅需保留工具 session 的短摘要（约 150 字）与状态。
- 工具完整记录只在执行阶段重要，可依赖工具本地私有会话格式，不要求长期归档。
- 当工具执行需要用户“选择/回复”时，必须能触达飞书用户并把用户答复回灌工具继续执行。

## 4. 关键原则
- 飞书会话主导协作。
- 工具会话主导执行。
- 协作轨与工具轨物理隔离，逻辑关联。

## 5. 方案结论

### 5.1 双轨模型
- `协作轨`：保存协作消息、任务进展、工具摘要卡片、引用事件。
- `工具轨`：保存或读取 Codex/Claude 的完整聊天上下文。

### 5.2 社交 App 能力边界
- 飞书原生界面不适合做复杂会话内多面板切换。
- 推荐模式：`社交 App 作为控制面`，`Web 工作台作为查看面`。
- 飞书消息中提供“工具会话卡片 + 打开全文链接 + 150 字摘要”。

### 5.3 多工具会话切换
- 同一协作会话可挂多个工具 session。
- 通过 `Session Switcher`（Web）或飞书命令切换当前查看目标。
- 协作时间线保持稳定，仅追加摘要和引用，不写入完整 transcript。

## 6. HITL（人类介入）闭环
- 工具运行中触发“需要用户输入”。
- 系统生成 `interaction_request` 并发送飞书交互卡片。
- 用户在飞书点击选项或输入文本。
- 飞书 webhook 回调到系统。
- 系统将答复写入对应工具进程 stdin。
- 工具继续执行，系统回传 150 字进展摘要到协作会话。

## 7. 最小接口范围（已形成草案）
- 飞书卡片字段：
- `Choice` 卡片（按钮选择）
- `Text` 卡片（自由输入）
- webhook 标准化 payload：
- 统一事件 `interaction.answer.submitted`
- 字段包含 `collab_session_id`、`tool_session_id`、`interaction_request_id`、`answer`、`idempotency_key`
- stdin 回灌接口：
- `POST /internal/tool-runs/{run_id}/stdin`
- 要求绑定校验、幂等、状态迁移与审计

对应详细定义见：
- `/Users/xm/Desktop/work_project/backend/helios_kernel/docs/飞书-HITL-桥接最小API草案.md`

## 8. 数据与状态最小建议
- 关联表：`tool_session_links`
- 交互表：`interaction_requests`
- 摘要表：`tool_session_summaries`（可与关联表合并）
- `interaction_requests` 状态：
- `PENDING -> RESOLVED`
- `PENDING -> EXPIRED`
- `PENDING -> CANCELLED`

## 9. 风险与约束
- 依赖工具本地私有会话格式作为长期方案，存在版本变更风险。
- 若仅依赖私有文件解析，实时交互识别稳定性不足。
- 实时 HITL 建议优先基于进程 stdout/stderr 信号，而非离线文件扫描。

## 10. 下一步落地建议
- 先实现 HITL 闭环最小链路（卡片、webhook、stdin 回灌）。
- 再实现多工具 session 的查看与切换界面。
- 最后补齐失败重试、幂等与审计报表。
