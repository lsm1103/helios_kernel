## 0. 排期假设（按周）

- 计划周期：6 周（每周 1 个固定评审点）。
- 交付节奏：每周完成 3 个任务项，共 18 项。

## 1. 周次排期

### Week 1（规格冻结）
- 1.1、1.2、1.3

### Week 2（Feishu 协作网关）
- 2.1、2.2、2.3

### Week 3（工具会话桥接）
- 3.1、3.2、3.3

### Week 4（HITL 闭环）
- 4.1、4.2、4.3

### Week 5（技术支持与策略控制）
- 5.1、5.2、5.3

### Week 6（验证与发布准备）
- 6.1、6.2、6.3

## 2. 任务明细（含验收标准）

### 2.1 规格基线与接口冻结（Week 1）

- [x] 1.1 评审并冻结 `proposal.md`、`design.md` 的范围与术语。  
验收标准：评审记录中明确范围边界与术语字典；评审后文档无 `TBD/TODO` 关键字。

- [x] 1.2 对齐 PRD 与 OpenSpec capability 命名，确保一一映射。  
验收标准：`docs/飞书分身机器人-MVP-PRD.md` 与 `openspec/changes/feishu-avatar-bot-mvp/specs/*` 存在一一映射表，且无孤立 capability。

- [x] 1.3 冻结 HITL 最小接口字段（卡片、webhook、stdin 回灌）。  
验收标准：字段清单在 `docs/飞书-HITL-桥接最小API草案.md` 固定，新增字段必须走变更评审。

### 2.2 Feishu 协作网关（Week 2）

- [x] 2.1 定义飞书消息入站事件到协作会话的映射规则。  
验收标准：覆盖私聊与群聊；明确 `(project_id, chat_thread_id, contact_id)` 生成逻辑；含冲突处理策略。

- [x] 2.2 定义私聊/群聊下 `chat_thread_id` 与 `contact_id` 解析规则。  
验收标准：私聊、群聊、@提及三类样例均给出输入输出示例；异常输入有拒绝规则。

- [x] 2.3 定义“响应回同线程”的验收用例与失败处理。  
验收标准：至少 3 个成功用例与 3 个失败用例；失败用例含重试或告警处理路径。

### 2.3 工具会话桥接（Week 3）

- [x] 3.1 定义 `tool_session_links` 数据模型与状态字段。  
验收标准：字段包含 `collab_session_id`、`tool_session_id`、`provider`、`status`、`last_active_at`；状态迁移图完整。

- [x] 3.2 定义多工具 session 的 list/use/peek 能力与约束。  
验收标准：三类操作均有请求/响应样例；并发切换冲突策略明确；权限边界明确。

- [x] 3.3 定义协作轨摘要卡片格式与 150 字摘要生成规则。  
验收标准：卡片模板固定；摘要长度限制与截断策略明确；不得泄露高风险敏感信息。

### 2.4 HITL 闭环（Week 4）

- [x] 4.1 定义 `interaction_requests` 状态机与超时策略。  
验收标准：覆盖 `PENDING/RESOLVED/EXPIRED/CANCELLED`；超时默认值、重试次数、过期处理明确。

- [x] 4.2 定义飞书卡片回调幂等规则与错误码。  
验收标准：`idempotency_key` 生成与校验规则明确；重复回调返回一致结果；错误码表完整。

- [x] 4.3 定义 `run_id` 绑定校验与 stdin 回灌审计规则。  
验收标准：绑定校验条件明确；回灌成功/失败均有审计字段；`RUN_NOT_ACTIVE` 等关键错误有可测用例。

### 2.5 技术支持与策略控制（Week 5）

- [x] 5.1 定义规则区/API 问答的检索范围与来源标识格式。  
验收标准：检索数据源白名单明确；回答模板含来源；无来源时返回“不确定”策略明确。

- [x] 5.2 定义命令白名单策略与高风险分级标准（L1/L2/L3）。  
验收标准：每级至少 5 个命令样例；默认拒绝规则明确；升级审批触发条件明确。

- [x] 5.3 定义审批人与审计事件最小字段集。  
验收标准：审批角色映射可配置；审计字段至少包含 actor、action、resource、result、timestamp、correlation_id。

### 2.6 验证与发布准备（Week 6）

- [x] 6.1 为四个 capability 补齐关键场景验收清单。  
验收标准：每个 capability 至少 5 个场景，覆盖成功、失败、幂等、权限四类路径。

- [x] 6.2 执行 `openspec validate feishu-avatar-bot-mvp --strict` 并修复问题。  
验收标准：校验结果为 `valid`；无 `ERROR` 级问题。

- [x] 6.3 输出实现前检查清单，作为 `/opsx:apply` 输入。  
验收标准：检查清单包含环境、依赖、接口冻结、风险预案、回滚策略五个部分，并完成评审签字。
